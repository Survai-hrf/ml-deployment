# syntax=docker/dockerfile:1

FROM nvidia/cuda:11.0.3-base-ubuntu20.04

WORKDIR /

COPY requirements.txt requirements.txt

# Install dependencies
RUN apt-get update && apt-get install -y \
    software-properties-common
RUN add-apt-repository universe
RUN apt-get update && apt-get install -y \
    python3.7 \
    python3-pip \
    git \
    curl

RUN pip3 install -r requirements.txt

COPY . .

RUN pip3 install -e git+https://seanbackstrom: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@github.com/Survai-hrf/ml-deployment.git@1217bc9e14f79f87640c2bbbe8e1ecd4b3b951e4#egg=mmaction2&subdirectory=app/mmaction2
# RUN pip3 install -e mmcv==1.5.0
RUN pip3 install -e -e git+https://seanbackstrom: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@github.com/Survai-hrf/ml-deployment.git@1217bc9e14f79f87640c2bbbe8e1ecd4b3b951e4#egg=mmcv_full&subdirectory=app/mmcv
RUN pip3 install -e -e git+https://seanbackstrom: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@github.com/Survai-hrf/ml-deployment.git@1217bc9e14f79f87640c2bbbe8e1ecd4b3b951e4#egg=mmdet&subdirectory=app/mmdetection

RUN pip install -r src/mmcv/requirements/optional.txt
RUN MMCV_WITH_OPS=1 pip install -e src/mmcv/.


CMD nvidia-smi
CMD ["python3", "-m" , "flask", "run", "--host=0.0.0.0"]